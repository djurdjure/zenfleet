@extends('layouts.admin.catalyst')

@section('title', 'Ajouter un Nouveau Véhicule')

@section('content')
{{-- Container pattern from components-demo.blade.php --}}
<section class="bg-white dark:bg-gray-900">
    <div class="py-8 px-4 mx-auto max-w-7xl lg:py-16">

        {{-- Header - Pattern from components-demo.blade.php --}}
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2 flex items-center gap-3">
                <x-iconify icon="heroicons:truck" class="w-8 h-8 text-blue-600 dark:text-blue-400" />
                Ajouter un Nouveau Véhicule
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                Complétez les 3 étapes pour enregistrer un véhicule dans la flotte
            </p>
        </div>

        {{-- Affichage des erreurs globales du formulaire --}}
        @if ($errors->any())
            <x-alert type="error" title="Erreurs de validation" dismissible class="mb-6">
                Veuillez corriger les erreurs suivantes avant de soumettre le formulaire :
                <ul class="mt-2 ml-5 list-disc text-sm">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </x-alert>
        @endif

        {{-- Formulaire multi-étapes avec Alpine.js --}}
        <div x-data="{
            currentStep: {{ old('current_step', 1) }}
        }"
        x-init="
            @if ($errors->any())
                let errors = {{ json_encode($errors->messages()) }};
                let firstErrorStep = null;
                const fieldToStepMap = {
                    'registration_plate': 1, 'vin': 1, 'brand': 1, 'model': 1, 'color': 1,
                    'vehicle_type_id': 2, 'fuel_type_id': 2, 'transmission_type_id': 2, 'manufacturing_year': 2, 'seats': 2, 'power_hp': 2, 'engine_displacement_cc': 2,
                    'acquisition_date': 3, 'purchase_price': 3, 'current_value': 3, 'initial_mileage': 3, 'status_id': 3, 'notes': 3
                };
                for (const field in fieldToStepMap) {
                    if (errors.hasOwnProperty(field)) {
                        firstErrorStep = fieldToStepMap[field];
                        break;
                    }
                }
                if (firstErrorStep) { currentStep = firstErrorStep; }
            @endif
        ">

            {{-- Stepper Component - Conformité 100% design system --}}
            <x-card padding="p-0" margin="mb-6">
                <x-stepper
                    :steps="[
                        ['label' => 'Identification', 'icon' => 'heroicons:identification'],
                        ['label' => 'Caractéristiques', 'icon' => 'heroicons:cog-6-tooth'],
                        ['label' => 'Acquisition', 'icon' => 'heroicons:currency-dollar']
                    ]"
                    currentStepVar="currentStep"
                />

                {{-- Formulaire --}}
                <form method="POST" action="{{ route('admin.vehicles.store') }}" enctype="multipart/form-data" class="p-6">
                    @csrf
                    <input type="hidden" name="current_step" x-model="currentStep">

                    {{-- ===========================================
                         ÉTAPE 1: IDENTIFICATION DU VÉHICULE
                         Pattern: components-demo Form Elements
                         =========================================== --}}
                    <div x-show="currentStep === 1" class="space-y-8">
                        {{-- Section Title Pattern --}}
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <x-iconify icon="heroicons:identification" class="w-5 h-5 text-blue-600 dark:text-blue-400" />
                                Informations d'Identification
                            </h3>

                            {{-- Grid Pattern from components-demo --}}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <x-input
                                    name="registration_plate"
                                    label="Immatriculation"
                                    icon="identification"
                                    placeholder="Ex: 16-12345-23"
                                    :value="old('registration_plate')"
                                    required
                                    :error="$errors->first('registration_plate')"
                                    helpText="Numéro d'immatriculation officiel du véhicule"
                                />

                                <x-input
                                    name="vin"
                                    label="Numéro de série (VIN)"
                                    icon="finger-print"
                                    placeholder="Ex: 1HGBH41JXMN109186"
                                    :value="old('vin')"
                                    :error="$errors->first('vin')"
                                    helpText="Vehicle Identification Number - 17 caractères"
                                />

                                <x-input
                                    name="brand"
                                    label="Marque"
                                    icon="building-storefront"
                                    placeholder="Ex: Renault, Peugeot, Toyota..."
                                    :value="old('brand')"
                                    required
                                    :error="$errors->first('brand')"
                                />

                                <x-input
                                    name="model"
                                    label="Modèle"
                                    icon="truck"
                                    placeholder="Ex: Clio, 208, Corolla..."
                                    :value="old('model')"
                                    required
                                    :error="$errors->first('model')"
                                />

                                <div class="md:col-span-2">
                                    <x-input
                                        name="color"
                                        label="Couleur"
                                        icon="swatch"
                                        placeholder="Ex: Blanc, Noir, Gris métallisé..."
                                        :value="old('color')"
                                        :error="$errors->first('color')"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    {{-- ===========================================
                         ÉTAPE 2: CARACTÉRISTIQUES TECHNIQUES
                         Pattern: components-demo TomSelect
                         =========================================== --}}
                    <div x-show="currentStep === 2" style="display: none;" class="space-y-8">
                        {{-- Section Title Pattern --}}
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <x-iconify icon="heroicons:cog-6-tooth" class="w-5 h-5 text-blue-600 dark:text-blue-400" />
                                Caractéristiques Techniques
                            </h3>

                            {{-- Grid Pattern 3 columns --}}
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <x-tom-select
                                    name="vehicle_type_id"
                                    label="Type de Véhicule"
                                    :options="$vehicleTypes->pluck('name', 'id')->toArray()"
                                    :selected="old('vehicle_type_id')"
                                    placeholder="Sélectionnez un type..."
                                    required
                                    :error="$errors->first('vehicle_type_id')"
                                    helpText="Catégorie du véhicule"
                                />

                                <x-tom-select
                                    name="fuel_type_id"
                                    label="Type de Carburant"
                                    :options="$fuelTypes->pluck('name', 'id')->toArray()"
                                    :selected="old('fuel_type_id')"
                                    placeholder="Sélectionnez un carburant..."
                                    required
                                    :error="$errors->first('fuel_type_id')"
                                    helpText="Source d'énergie du véhicule"
                                />

                                <x-tom-select
                                    name="transmission_type_id"
                                    label="Type de Transmission"
                                    :options="$transmissionTypes->pluck('name', 'id')->toArray()"
                                    :selected="old('transmission_type_id')"
                                    placeholder="Sélectionnez une transmission..."
                                    required
                                    :error="$errors->first('transmission_type_id')"
                                    helpText="Type de boîte de vitesse"
                                />

                                <x-input
                                    type="number"
                                    name="manufacturing_year"
                                    label="Année de Fabrication"
                                    icon="calendar"
                                    placeholder="Ex: 2024"
                                    :value="old('manufacturing_year')"
                                    :error="$errors->first('manufacturing_year')"
                                    min="1900"
                                    max="2099"
                                />

                                <x-input
                                    type="number"
                                    name="seats"
                                    label="Nombre de places"
                                    icon="user-group"
                                    placeholder="Ex: 5"
                                    :value="old('seats')"
                                    :error="$errors->first('seats')"
                                    min="1"
                                    max="99"
                                />

                                <x-input
                                    type="number"
                                    name="power_hp"
                                    label="Puissance (CV)"
                                    icon="bolt"
                                    placeholder="Ex: 90"
                                    :value="old('power_hp')"
                                    :error="$errors->first('power_hp')"
                                    min="0"
                                />

                                <div class="lg:col-span-3">
                                    <x-input
                                        type="number"
                                        name="engine_displacement_cc"
                                        label="Cylindrée (cc)"
                                        icon="wrench-screwdriver"
                                        placeholder="Ex: 1500"
                                        :value="old('engine_displacement_cc')"
                                        :error="$errors->first('engine_displacement_cc')"
                                        helpText="Capacité du moteur en centimètres cubes"
                                        min="0"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    {{-- ===========================================
                         ÉTAPE 3: ACQUISITION & STATUT
                         Pattern: components-demo Datepicker + Multiple TomSelect
                         =========================================== --}}
                    <div x-show="currentStep === 3" style="display: none;" class="space-y-8">
                        {{-- Section Title Pattern --}}
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <x-iconify icon="heroicons:currency-dollar" class="w-5 h-5 text-blue-600 dark:text-blue-400" />
                                Acquisition & Statut
                            </h3>

                            {{-- Grid Pattern --}}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <x-datepicker
                                    name="acquisition_date"
                                    label="Date d'acquisition"
                                    :value="old('acquisition_date')"
                                    format="d/m/Y"
                                    :error="$errors->first('acquisition_date')"
                                    placeholder="Choisir une date"
                                    helpText="Date d'achat du véhicule"
                                />

                                <x-input
                                    type="number"
                                    name="purchase_price"
                                    label="Prix d'achat (DA)"
                                    icon="currency-dollar"
                                    placeholder="Ex: 2500000"
                                    :value="old('purchase_price')"
                                    :error="$errors->first('purchase_price')"
                                    step="0.01"
                                    min="0"
                                    helpText="Prix d'achat en Dinars Algériens"
                                />

                                <x-input
                                    type="number"
                                    name="current_value"
                                    label="Valeur actuelle (DA)"
                                    icon="currency-dollar"
                                    placeholder="Ex: 2000000"
                                    :value="old('current_value')"
                                    :error="$errors->first('current_value')"
                                    step="0.01"
                                    min="0"
                                    helpText="Valeur estimée actuelle"
                                />

                                <x-input
                                    type="number"
                                    name="initial_mileage"
                                    label="Kilométrage Initial"
                                    icon="chart-bar"
                                    placeholder="Ex: 0"
                                    :value="old('initial_mileage', 0)"
                                    :error="$errors->first('initial_mileage')"
                                    min="0"
                                    helpText="Kilométrage au moment de l'acquisition"
                                />

                                {{-- Statut Initial --}}
                                <div class="md:col-span-2">
                                    <x-tom-select
                                        name="status_id"
                                        label="Statut Initial"
                                        :options="$vehicleStatuses->pluck('name', 'id')->toArray()"
                                        :selected="old('status_id')"
                                        placeholder="Sélectionnez un statut..."
                                        required
                                        :error="$errors->first('status_id')"
                                        helpText="État opérationnel du véhicule"
                                    />
                                </div>

                                {{-- Utilisateurs Autorisés - Multiple TomSelect Pattern --}}
                                <div class="md:col-span-2">
                                    <x-tom-select
                                        name="users"
                                        label="Utilisateurs Autorisés"
                                        :options="$users->mapWithKeys(fn($user) => [$user->id => $user->name . ' (' . $user->email . ')'])->toArray()"
                                        :selected="old('users', [])"
                                        placeholder="Rechercher des utilisateurs..."
                                        :multiple="true"
                                        :error="$errors->first('users')"
                                        helpText="Sélectionnez les utilisateurs autorisés à utiliser ce véhicule"
                                    />
                                </div>

                                {{-- Notes --}}
                                <div class="md:col-span-2">
                                    <x-textarea
                                        name="notes"
                                        label="Notes"
                                        rows="4"
                                        placeholder="Informations complémentaires sur le véhicule..."
                                        :value="old('notes')"
                                        :error="$errors->first('notes')"
                                        helpText="Ajoutez toute information utile (état, équipements, historique...)"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    {{-- ===========================================
                         ACTIONS FOOTER
                         Pattern: components-demo Buttons avec variants
                         =========================================== --}}
                    <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
                        <div>
                            {{-- Bouton Précédent - Pattern secondary from components-demo --}}
                            <x-button
                                type="button"
                                variant="secondary"
                                icon="arrow-left"
                                x-show="currentStep > 1"
                                @click="currentStep--"
                            >
                                Précédent
                            </x-button>
                        </div>

                        <div class="flex items-center gap-3">
                            {{-- Lien Annuler - Pattern from components-demo --}}
                            <a href="{{ route('admin.vehicles.index') }}"
                               class="text-sm font-semibold text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">
                                Annuler
                            </a>

                            {{-- Bouton Suivant - Pattern primary from components-demo --}}
                            <x-button
                                type="button"
                                variant="primary"
                                icon="arrow-right"
                                iconPosition="right"
                                x-show="currentStep < 3"
                                @click="currentStep++"
                            >
                                Suivant
                            </x-button>

                            {{-- Bouton Enregistrer - Pattern success from components-demo --}}
                            <x-button
                                type="submit"
                                variant="success"
                                icon="check-circle"
                                x-show="currentStep === 3"
                            >
                                Enregistrer le Véhicule
                            </x-button>
                        </div>
                    </div>
                </form>
            </x-card>

        </div>

    </div>
</section>
@endsection
